# FaxRetriever 2.0 & FaxRetrieverAdmin 2.0 — System Alignment Reference
**Version: Consolidation Draft 1**  
**Scope: Complete system alignment for forward execution — no resets**

---

## 1. SYSTEM ARCHITECTURE OVERVIEW

**FaxRetrieverAdmin (FRA):**
- Licensing and client registration authority
- Credential Vault (Sensitive reseller API credentials used for communicating with SkySwitch)
- Enforces single retriever device per client domain (via `device_id` + `selected_fax_number`)
- Issues JWT to FR via /init
- Issues SkySwitch Bearer Token to FR via /bearer
- Maintains access logs and audit trails
- Provides at-a-glance client and reseller information, token status, retriever, etc.

**FaxRetriever (FR):**
- Runs as a standalone .exe or via SMB share (.exe).
- Core config files are stored adjacent to FaxRetriever (`./shared/config/config.json`), client-specific settings are stored at `%LOCALAPPDATA%\Clinic Networking, LLC\FaxRetriever\`
- Operational config cached in memory
- Handles all fax transmission and retrieval
- Operates in either **Sender** or **Sender/Receiver** mode
- Retains no decrypted SkySwitch credentials

---

## 2. COMPONENT ROLES & BOUNDARIES

| Capability                        | FRA                                       | FR                           |
|-----------------------------------|-------------------------------------------|------------------------------|
| Stores API credentials            | Yes (encrypted)                           | Never                        |
| Issues JWT for access control     | Yes                                       | No                           |
| Retrieves SkySwitch bearer token  | Yes                                       | No (requests it via /bearer) |
| Sends/receives fax                | No                                        | Yes                          |
| Stores fax content or metadata    | No                                        | Yes                          |
| Maintains per-number retriever lock | Yes (via device_id + selected_fax_number) | Yes (enforces on launch)     |
| Operates under user control (GUI) | Yes                                       | Yes                          |

* Retriever Lock ensures only one FR instance per fax number may retrieve faxes at a time

---

## 3. TOKEN & CREDENTIAL LIFECYCLE

**Authentication Flow**:
1. Admin registers `reseller` in FRA
   1. FRA-Resellers stores: `voice_api_user`, `voice_api_password`, `msg_api_user`, `msg_api_password`, `contact_name`, `contact_email`, `contact_phone`, `note` as `reseller_blob` with `reseller_id` as the identifier.
2. Admin registers `client` in FRA
   1. FRA stores: `fax_user`, `authentication_key`, `all_fax_numbers`
3. Admin or User configures FR with `fax_user` and `authentication_token` in App Settings
   1. FR queries /init with `authentication_key` + `fax_user`
   2. FRA verifies and returns `JWT` + `domain_uuid` scoped to that domain
   3. FR queries /bearer with `JWT` + `domain_uuid`
   4. FRA verifies JWT and returns Skyswitch Bearer Token payload (bearer token, issue time, expiration time)
   5. FR stores Bearer Token payload and uses Bearer Token to retrieve faxes
4. FR uses Bearer Token to communicate with Skyswitch API for fax retrieval and sending

**Authentication Key**:
- Randomly generated by FRA during fax_user configuration (10-digit code in hyphenated groups of 5)
- Used to retrieve JWT from FRA
- Unique per `fax_user`

**JWT (FR->FRA Access Token)**:
- Signed via HS256
- Claims: `domain_uuid`, `device_id`, `scope`, `iat`, `exp`
- TTL: 24 hours

**Bearer Token**:
- Acquired from SkySwitch per `fax_user` using stored `reseller` credentials
- Retrieved and cached by FRA
- Expires every ~24 hours - declared by SkySwitch in Bearer token payload
- Returned to FR on `/bearer` request

Note: Bearer Token is issued by SkySwitch and stored in FRA. Bearer token includes expiration time (for the bearer token, not JWT) in payload. 
FRA MUST proactively retrieve new bearer tokens from SkySwitch prior to expiration.
---

## 4. DATA STRUCTURES & SCHEMAS

**Reseller Information**
- Resellers are configured in FRA by Clinic Networking, LLC
- Resellers are 3rd party companies that use SkySwitch for their VoIP platform and that would like to use FaxRetriever for their clients
- Resellers are identified by their SkySwitch `reseller_id`
- Reseller information includes `voice_api_user`, `voice_api_password`, `msg_api_user`, `msg_api_password`, `contact_name`, `contact_email`, `contact_phone`, `note`
- Reseller accounts are stored in `resellers` collection
- Resellers pay a monthly fee to Clinic Networking, LLC for access to FaxRetriever

**Client Information**
- Clients are configured in FRA by Clinic Networking, LLC
- Clients are the end-users of FaxRetriever
- Clients are identified by the `fax_user` which includes the `reseller_id` (example: fax_user `100@clientdomain.12345.service` is a client of reseller `12345`)
- Client information includes `fax_user`, `authentication_token`, `all_fax_numbers` (a list of all Fax phone numbers provisioned for the client account)
- Client accounts are stored in `clients` collection
- Clients pay a monthly fee to their reseller for access to FaxRetriever

## Variable Structures

**Reseller Information**

***`reseller_id` structure***
- Format: `#####`

***`voice_api_username` and `_password`***
- Username Format: `username@destination`
- Password Format: `password_string`

***`msg_api_username` and `_password`***
- Username Format: `00000000-0000-0000-0000-000000000000`
- Password Format: `password_string`

***contact information***
- Contact Name Format: `string` first and last name or business name (business name preferred)
- Contact Email Format: `string` valid email address
- Contact Phone Format: `string` valid phone number
- Note Format: `string` any additional information about the reseller

**Client Information**

***`fax_user` structure***  
- Format: `[extension]@[client_domain].[reseller_id].service`

**`authentication_token` structure**
- Format: `#####-#####`

**`all_fax_numbers` structure**
- Format: `list` of `string` valid fax numbers for the client account
ToDo: Update function to pull *all* existing fax numbers. Presently, it only pulls the first number from the database.

**`retriever_assignments` structure**
- Format: object with keys as fax numbers and values as hostnames
  Example:
  {
    "+14055551234": "DESKTOP-ABC123",
    "+14055552345": "DESKTOP-XYZ789"
  }



## Config Model

**Global Config File (`config.json`)**
- Stored adjacent to FaxRetriever.exe under `shared/config/`
- Includes all *global* system and account settings:
  - Fax Options
    - None - Global settings are not applicable to Fax Options
  - Account Settings 
    - `validation_status`, `fax_user`, `authentication_key`, `all_fax_numbers`
  - Token Settings
    - JWT settings
      - `jwt_token`
    - Bearer Token Details
      - `bearer_token`, `bearer_token_expiration`, `bearer_token_retrieved`
      - ToDo: The bearer_token_retrieved field is currently being updated by the client, but should be fixed to the time the token was retrieved by FRA.
  - Integration Details
    - `enable_third_party`, `integration_software`, `[any additional integration options and settings]`
    - Note: Some Integration Options may require `retriever_mode` to be set to `sender_receiver`, while skipping the integration actions on any client with `retriever_mode` set to `sender`
  - System Settings
    - Application Logging Level

**Client Config File (`config.json`)**
- Stored at `%LOCALAPPDATA%\Clinic Networking, LLC\FaxRetriever\`
- Includes all *user* level settings:
  - Fax Options:
    - `download_method`, `file_name_format`, `polling_frequency`, `print_faxes`, `delete_faxes`, `archive_enabled`, `archive_duration`
    - Note: Only include Fax Options if `retriever_mode` is set to `sender_receiver` otherwise, skip this section. 
  - Account Settings 
    - `retriever_mode`, `selected_fax_number`
    - Note: retriever_mode may be `sender` or `sender_receiver`. `sender_receiver` may be overridden by JWT `retriever_status` = `denied`.
    - Note: Only one `sender_receiver` client per domain is allowed to prevent race conditions or duplication of faxes. All other clients will be forced into `sender` mode by `retriever_status` = `denied`.
  - Token Settings
    - JWT settings
      - `retriever_status`
      - Note: `retriever_status`, if `denied` overrides `retriever_mode` to `sender`, disabling fax retrieval at the client level.
    - Bearer Token Details
      - None - Client-level settings are not applicable to Bearer Token Details
  - Integration Details
    - None - Client-level settings are not applicable to Integration Details
  - System Settings
    - None - Client-level settings are not applicable to System Settings.

---

## 5. LOGGING & AUDIT MODEL

**Collections**:
- `access_logs`: high-level interaction history (90-day TTL)
- `audit_logs`: full detail, actor attribution, payloads (365-day TTL)

**Log Entry Format** (Required Fields):
- `timestamp`, `event_type`, `domain_uuid`, `device_id`, `note`
- `actor`: { `component`, `function`, `request_id` }
- `object`: { `type`, `operation`, `payload` }

**UI Behavior**:
- Green = payload present  
- Red = destructive action (`delete`)  
- Amber = `fail` or `error`  
- White = neutral

**Mandatory Log Events**:
- Init success/denied
- JWT and bearer token issuance/failures
- All SkySwitch interactions (send/request/error)
- Any admin GUI additive or destructive actions

---

## 6. OPERATIONAL CONTROLS

**Retriever Assignment**:
- One device per fax number may retrieve faxes
- FRA stores `retriever_assignments` mapping each fax number to a specific device_id (hostname)
- If no retriever is assigned to the selected fax number and FR is in `sender_receiver` mode, FRA assigns retriever rights
- If the selected number already has a retriever and it does not match the current device_id, FRA responds with `retriever_status = denied`

- FR must check during `/init`
  - If no retriever assigned: device becomes retriever (if mode = `sender_receiver`)
  - If retriever already exists and does not match current client: FRA forces fallback to Sender mode

**Mode Selection in FR**:
- Within the system options, the user selects a `retriever_mode` of `sender_receiver`
- The system will enforce this only if FRA authorizes retrieval for the selected fax number
- Mode Selection is ultimately controlled by FRA's `retriever_status` response and may be overridden if status = `denied`. 

**Token Refresh Timing**:
- FRA auto-refreshes all cached bearer tokens between 2am–4am local
- JWTs must be re-issued by client on expiry

---

## 7. CURRENT MILESTONES (COMPLETED)

- Token flow design finalized and documented
- FRA credential storage secured with AES-GCM
- MongoDB schema for logs and domain state implemented
- Config, and identity schema established
- FRA API endpoints (`/init`, `/bearer`) defined and secured
- Structured logging (`log_event_v2`) active and routed per spec

---

## 8. OUTSTANDING TASKS

- [ ] SkySwitch fax number discovery implementation once documentation is released
- [ ] Export options (CSV/JSON) for audit logs
- [ ] Real-time log overlay or polling viewer in FRA GUI
- [ ] Validation/test harnesses for simulated init, bearer, retriever collision
- [ ] System-level failure mode testing (e.g., bearer token expired + retriever mismatch)

---

## 9. VALIDATION & SAFETY MECHANISMS

- Init tokens are short-lived and scoped
- Access to `/bearer` requires valid JWT
- No system ever stores SkySwitch credentials on the client
- JWT is stateless and revocation is enforced by `active: false` flag in DB
- Audit logs are tamper-resistant (payload embedded per request_id)
- Retriever reassignment only via admin GUI in FRA

---

## 10. DEPLOYMENT ASSUMPTIONS

- FRA runs persistently on a management server or share
- FR is installed per client-site device
- Only one FR instance may serve as retriever
- All comms occur over TLS via requests-based HTTP calls
- PyInstaller packaging; no CORS or browser client involved
- Local storage only for fax metadata and encrypted configuration
- No fax content ever processed or stored in FRA

---

**Next Phase Options (Developer-Controlled):**
- Build simulated init/bearer request tester (offline mode)
- Implement monitoring/stats overlay into FRA UI
- Develop system-wide “config drift” warning mechanism
- Lock UI elements based on `active: false` state from FRA response
- Phase in retriever handoff system (e.g., force release + reassign)