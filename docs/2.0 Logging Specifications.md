# FaxRetrieverAdmin 2.0 â€” Logging Specification

## Purpose

This document defines the mandatory structure, routing, behavior, and visual standards for all logging performed within the FaxRetrieverAdmin (FRA) system. It exists to guarantee full operational observability, traceability, and audit readiness for every component.

---

## Log Storage

- **MongoDB Collections:**
  - `access_logs`: summary records of client interaction and lifecycle events.
  - `audit_logs`: detailed, structured entries with payloads, actor context, and object relationships.

- **TTL Management:**
  - `access_logs`: 90-day rolling retention
  - `audit_logs`: 365-day rolling retention (or longer)

---

## Log Event Schema

All logs must conform to this structure:

```json
{
  "timestamp": "UTC_ISO8601",
  "event_type": "snake_case_descriptor",
  "domain_uuid": "optional-client-scope",
  "device_id": "optional-device-scope",
  "source_ip": "optional-ip-source",
  "note": "human-readable description",
  "actor": {
    "component": "module_or_app",
    "function": "calling_function",
    "request_id": "uuid4"
  },
  "object": {
    "type": "entity_being_modified",
    "operation": "action_taken",
    "payload": { "...json_data..." }
  }
}
```

---

## Logging Interfaces

- `log_event(...)`: Legacy, minimal logger for compatibility **(Deprecated)**
- `log_event_v2(...)`: Preferred structured logger, must be used for all new logic.
- `auto_log_event(...)`: Decorator for automatic entry/exit/exception logging.

All loggers route to appropriate collections depending on `audit=True`.

---

## System Actor Attribution

- All logs must assign `actor_component=SYSTEM_ACTOR`.
- Value is derived from Windows user:

```python
import os
user = os.getlogin()
SYSTEM_ACTOR = f"{user}"
```

---

## Visual Audit UI Behavior

### Dynamic Row Highlighting

- ðŸŸ© Green â€” entries with non-empty `payload`
- ðŸŸ¥ Red â€” `event_type` includes `delete`
- ðŸŸ§ Amber â€” `event_type` includes `fail` or `error`
- âšª White â€” neutral/default

### View Modes

- **Basic:** Timestamp, Event Type, Actor, Note.
- **Advanced:** Full column breakdown including UUID, IP, Object, Payload.

### Extras

- Split panel with payload viewer (JSON rendered).
- Filter by collection and event type.
- 200-row rolling limit per query.

---

## Event Type Guidelines

| Category       | Prefix / Sample Type                                           |
| -------------- | -------------------------------------------------------------- |
| Initialization | `init_success`, `init_denied`                                  |
| Auth / Token   | `jwt_issued`, `jwt_invalid`, `bearer_issued`, `refresh_failed` |
| CRUD           | `client_added`, `reseller_deleted`, `fax_numbers_updated`      |
| Errors         | `refresh_failed`, `skyswitch_error`, `decrypt_fail`            |
| Audit Actions  | `reseller_blob_saved`, `reseller_blob_decrypted`               |

All `event_type` values must be lowercase with underscores.

---

## Coverage Requirements

- All critical backend operations (create, update, delete, fail) must be logged.
- All token issuance and credential manipulation must be audit-logged.
- All SkySwitch interactions must log:
  - When request sent.
  - Status received.
  - Errors thrown.
- All GUI-initiated destructive actions must produce audit entries.

---

## Future Work

- Optional export to CSV/JSON.
- Log search/filter by domain/device.
- Real-time event stream (WebSocket or polling overlay).
- Severity tiers.

---

## Compliance Mandate

This spec is considered a foundational requirement for the FRA 2.0 security and audit model. Deviation from these logging expectations is not permitted without written override.